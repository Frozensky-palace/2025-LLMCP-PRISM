# PRISM 项目方案

> **Prompt Refinement & Image Synthesis Manager**
> 基于 LLM 的 AI 绘画 Prompt 优化中间层

---

## 一、项目背景与动机

### 1.1 问题现状

当前 AI 绘画工具（Stable Diffusion、Midjourney、SeeDream 等）普遍存在一个核心痛点：

**用户很难写出能准确表达创意的 Prompt**

- 即使是有经验的用户，也经常需要多次尝试才能得到满意的效果
- 新手用户更是无从下手，不知道如何描述光照、构图、风格等专业要素
- 当生成的图片不满意时，用户不知道应该修改 Prompt 的哪个部分

### 1.2 现有解决方案的不足

目前市面上的方案：

1. **Prompt 生成器**：只能一次性生成，缺乏迭代优化能力
2. **Prompt 模板库**：固定模板，灵活性不足
3. **直接使用模型**：SeeDream/Gemini 支持自然语言，但用户表达不够专业

### 1.3 PRISM 的创新点

我们的核心思路是：**在用户和生成模型之间增加一个智能中间层**

```
用户自然语言 → [PRISM 优化层] → 专业 Prompt → 生成模型 → 图片
                   ↑
              GPT-4o + 专业模板
```

**三大核心能力**：

1. **智能 Prompt 生成**：用户说人话，系统生成专业级详细描述
2. **精确迭代优化**：通过 Prompt Diff 机制，只修改相关部分
3. **完整版本管理**：支持历史查看、对比、回滚

---

## 二、项目定位与目标

### 2.1 项目定位

- **类型**：LLM 课程大作业
- **场景**：个人/小团队使用的 AI 绘画辅助工具
- **技术重点**：展示 LLM 深度应用 + Prompt Engineering + 现代 Web 架构

### 2.2 核心目标

**功能目标**：
- 用户可以用简单语言描述创意，系统生成专业 Prompt 并生成图片
- 用户可以对图片提出反馈，系统精确修改并重新生成
- 用户可以查看历史版本，对比效果，回滚到任意版本

**技术目标**：
- 展示对 LLM 的深度应用（不只是简单调用 API）
- 展示创新的 Prompt Diff 机制
- 展示结构化数据设计能力
- 展示现代 Web 开发规范

### 2.3 非目标（MVP 阶段不做）

- ❌ 多用户系统、权限管理
- ❌ 付费计费功能
- ❌ 社交分享功能
- ❌ 移动端适配

---

## 三、系统架构设计

### 3.1 整体架构图

```
┌──────────────────────────────────────────────────────────┐
│                         前端层                            │
│                  Vue 3 + TypeScript                       │
│  ┌────────────┐  ┌────────────┐  ┌────────────┐         │
│  │  输入面板  │  │  图片展示  │  │  版本历史  │         │
│  └────────────┘  └────────────┘  └────────────┘         │
└────────────────────────┬─────────────────────────────────┘
                         │ REST API
┌────────────────────────▼─────────────────────────────────┐
│                      后端服务层                           │
│                   FastAPI + Python                        │
│  ┌───────────────────────────────────────────────────┐  │
│  │             Prompt Engine                         │  │
│  │  • 接收用户输入                                    │  │
│  │  • 调用 GPT-4o + System Prompt                    │  │
│  │  • 生成结构化 Schema                               │  │
│  └───────────────────────────────────────────────────┘  │
│  ┌───────────────────────────────────────────────────┐  │
│  │           Feedback Engine                         │  │
│  │  • 理解用户反馈                                    │  │
│  │  • 生成 Prompt Diff                                │  │
│  │  • 应用 Diff 到 Schema                             │  │
│  └───────────────────────────────────────────────────┘  │
│  ┌───────────────────────────────────────────────────┐  │
│  │            Adapter Layer                          │  │
│  │  • Schema → SeeDream Prompt                       │  │
│  │  • 未来支持多模型（SD3.5 等）                      │  │
│  └───────────────────────────────────────────────────┘  │
└────────────────────────┬─────────────────────────────────┘
                         │
┌────────────────────────▼─────────────────────────────────┐
│                    外部服务层                             │
│  ┌──────────────┐  ┌──────────────┐  ┌──────────────┐  │
│  │  OpenAI API  │  │  SeeDream    │  │  PostgreSQL  │  │
│  │   (GPT-4o)   │  │     API      │  │   Database   │  │
│  └──────────────┘  └──────────────┘  └──────────────┘  │
└──────────────────────────────────────────────────────────┘
```

### 3.2 数据流程

#### 首次生成流程

```
1. 用户输入："画一只猫"
   ↓
2. Prompt Engine 处理：
   - 读取 System Prompt 模板
   - 调用 GPT-4o
   - 解析返回的结构化 Schema
   ↓
3. Adapter Layer 转换：
   - Schema → SeeDream 格式的自然语言 Prompt
   ↓
4. 调用 SeeDream API：
   - 生成图片
   - 存储图片到本地
   ↓
5. 存储到数据库：
   - Session（会话）
   - Version（版本1：原始 Schema + Prompt + Image URL）
   ↓
6. 返回给前端展示
```

#### 多轮迭代流程

```
1. 用户反馈："太暗了"
   ↓
2. Feedback Engine 处理：
   - 读取反馈 System Prompt
   - 调用 GPT-4o 分析反馈
   - 生成 Prompt Diff：
     {
       "operations": [
         {"action": "add", "field": "lighting", "values": ["更亮的环境光"]},
         {"action": "adjust", "field": "weights.lighting", "delta": 0.3}
       ]
     }
   ↓
3. 应用 Diff：
   - 从数据库读取版本1的 Schema
   - 应用 Diff 操作
   - 生成新的 Schema
   - 检测冲突
   ↓
4. Adapter Layer 转换：
   - 新 Schema → SeeDream Prompt
   ↓
5. 调用 SeeDream API：
   - 传入原图片 + 修改指令
   - 生成新图片
   ↓
6. 存储版本2：
   - parent_version_id = 版本1
   - 存储 Diff + 新 Schema + 新 Image
   ↓
7. 返回给前端展示（可对比新旧版本）
```

### 3.3 技术栈选型

| 层级 | 技术选型 | 理由 |
|------|---------|------|
| **前端框架** | Vue 3 + TypeScript | 响应式开发，类型安全 |
| **前端 UI** | Element Plus | 组件丰富，适合快速开发 |
| **状态管理** | Pinia | Vue 3 官方推荐 |
| **后端框架** | FastAPI | 异步支持，自动文档，类型提示 |
| **数据库** | PostgreSQL | 支持 JSONB，适合存储 Schema |
| **ORM** | SQLAlchemy | Python 标准 ORM |
| **LLM** | OpenAI GPT-4o | 理解能力强，输出稳定 |
| **图像生成** | SeeDream API | 支持中文，支持图片输入 |
| **容器化** | Docker Compose | 统一开发环境 |

---

## 四、核心模块详解

### 4.1 Prompt Schema（数据骨架）

**设计思路**：将自然语言 Prompt 结构化为 JSON，使其可编程、可追踪、可修改。

```json
{
  "id": "uuid",
  "version": 1,
  "subject": ["一只猫"],
  "appearance": ["橘色毛发", "蓝色眼睛", "蓬松尾巴"],
  "style": ["半写实", "动漫风格", "柔和线条"],
  "composition": ["特写", "浅景深", "正面视角"],
  "lighting": ["柔和侧光", "暖色调", "轮廓高光"],
  "background": ["窗边", "清晨", "朦胧背景"],
  "quality": ["高清", "细节丰富", "4K"],
  "negative": ["模糊", "变形", "多余肢体"],
  "weights": {
    "style": 1.0,
    "realism": 0.7,
    "lighting": 0.8
  },
  "metadata": {
    "model": "seedream",
    "created_at": "2025-12-18T10:00:00Z",
    "parent_id": null
  }
}
```

**字段说明**：

| 字段 | 说明 | 示例 |
|------|------|------|
| `subject` | 主体描述 | ["一只猫", "坐姿"] |
| `appearance` | 外观细节 | ["橘色毛发", "蓝色眼睛"] |
| `style` | 画风风格 | ["半写实", "动漫风格"] |
| `composition` | 构图方式 | ["特写", "浅景深"] |
| `lighting` | 光照描述 | ["柔和侧光", "暖色调"] |
| `background` | 背景描述 | ["窗边", "清晨"] |
| `quality` | 质量要求 | ["高清", "4K"] |
| `negative` | 负面提示 | ["模糊", "变形"] |
| `weights` | 权重参数 | {"style": 1.0, "realism": 0.7} |

### 4.2 Prompt Engine（生成阶段）

**职责**：将用户的简单描述转换为专业的结构化 Prompt。

**核心技术**：GPT-4o + 精心设计的 System Prompt

**System Prompt 设计**（基于对话文件 aa 提取）：

```text
你是一个专业的 AI 绘画 Prompt 生成器，擅长将用户的简单描述转换为详细、结构化的绘画指令。

【输出格式】
你必须输出 JSON 格式，包含以下字段：
{
  "subject": ["主体描述"],
  "appearance": ["外观细节"],
  "style": ["画风风格"],
  "composition": ["构图方式"],
  "lighting": ["光照描述"],
  "background": ["背景描述"],
  "quality": ["质量要求"],
  "negative": ["负面提示"],
  "weights": {"style": 1.0, "realism": 0.7}
}

【生成规则】
1. 根据用户输入填充所有字段，保证完整性
2. 使用专业绘画术语（如：rim light、bokeh、cinematic composition、soft cel-shading）
3. 避免冲突（不能同时要求 realistic 和 cartoon）
4. 为中文描述，适配 SeeDream 模型
5. 如果用户输入简单，合理补充细节（但不偏离主题）

【参考案例】
案例1（秋日草地三人场景）：
用户输入："三个人躺在草地上看落叶"
Schema 输出：
{
  "subject": ["三位角色", "头对头躺在草地"],
  "appearance": ["面部清晰", "服装自然", "头发随风散开"],
  "style": ["二次元半写实", "明显线条感", "真实光影"],
  "composition": ["俯拍70度", "圆形构图", "头部居中"],
  "lighting": ["温暖午后光", "侧逆光", "柔和高光"],
  "background": ["秋天草地", "黄绿褐色", "落叶飘落"],
  "quality": ["16:9", "1920x1080", "高清细腻"],
  "negative": ["模糊", "变形", "过度扁平"],
  "weights": {"style": 1.0, "realism": 0.8}
}

案例2（站台场景）：
用户输入："一个人坐在地铁站台边缘，雾气弥漫"
Schema 输出：
{
  "subject": ["一位角色坐在站台边缘"],
  "appearance": ["动漫线条", "柔和上色", "沉静表情"],
  "style": ["电影感", "半写实背景", "动漫角色"],
  "composition": ["平视", "中距离", "对面视角"],
  "lighting": ["清晨淡金蓝混合", "体积雾", "柔光"],
  "background": ["地铁站台", "轻微雾气", "轨道延伸"],
  "quality": ["16:9", "高清", "浅景深"],
  "negative": ["拥挤", "科幻UI", "夸张比例"],
  "weights": {"style": 1.0, "realism": 0.6}
}

【重要提示】
- 保持所有描述为中文
- 确保 JSON 格式正确
- 每个数组至少有1-3个元素
- weights 的值在 0.1-1.5 之间
```

**实现流程**：

```python
def generate_prompt(user_input: str) -> dict:
    """
    生成结构化 Prompt

    Args:
        user_input: 用户的简单描述

    Returns:
        {
            "schema": {...},  # 结构化 Schema
            "prompt": "...",  # 自然语言 Prompt（用于传给模型）
        }
    """
    # 1. 读取 System Prompt 模板
    system_prompt = load_system_prompt("generation.txt")

    # 2. 调用 GPT-4o
    response = openai.ChatCompletion.create(
        model="gpt-4o",
        messages=[
            {"role": "system", "content": system_prompt},
            {"role": "user", "content": user_input}
        ],
        response_format={"type": "json_object"}
    )

    # 3. 解析 Schema
    schema = json.loads(response.choices[0].message.content)

    # 4. 验证 Schema 完整性
    validate_schema(schema)

    # 5. 渲染为自然语言 Prompt
    prompt = render_schema_to_prompt(schema)

    return {"schema": schema, "prompt": prompt}
```

### 4.3 Feedback Engine（迭代核心）

**职责**：理解用户反馈，生成最小修改集（Prompt Diff）。

**System Prompt 设计**（反馈阶段）：

```text
你是一个 Prompt 反馈分析器，负责理解用户对图片的反馈，并生成精确的修改指令。

【任务】
根据用户反馈，生成 Prompt Diff JSON：
{
  "operations": [
    {"action": "add", "field": "lighting", "values": ["更亮的光线"]},
    {"action": "remove", "field": "background", "values": ["复杂背景"]},
    {"action": "adjust", "field": "weights.lighting", "delta": 0.3}
  ],
  "reasoning": "用户反馈图片太暗，因此增加lighting字段的亮度描述，并提升权重"
}

【反馈映射规则】
常见反馈类型 → 对应字段：
- "太暗" / "太亮" / "光线不好" → lighting
- "脸怪" / "人物变形" / "表情不对" → appearance + negative
- "背景太乱" / "背景太简单" → background
- "风格不对" / "不够写实" / "太卡通" → style + weights
- "构图不好" / "角度不对" → composition
- "不够清晰" / "质量不好" → quality

【操作类型】
1. add: 在指定字段添加新的描述元素
2. remove: 从指定字段移除某些元素
3. adjust: 调整 weights 权重（delta 范围 -0.5 到 +0.5）
4. replace: 完全替换某个字段（慎用）

【关键原则】
1. 最小修改：只修改与反馈相关的字段
2. 保持一致：不要改变用户未提及的内容
3. 冲突检测：如果修改会导致矛盾，在 reasoning 中说明
4. 解释清楚：在 reasoning 中说明为什么这样修改

【示例】
用户反馈："太暗了"
原 Schema: {"lighting": ["柔和侧光"], "weights": {"lighting": 0.5}}
Diff 输出:
{
  "operations": [
    {"action": "add", "field": "lighting", "values": ["更亮的环境光", "增加高光"]},
    {"action": "adjust", "field": "weights.lighting", "delta": 0.3}
  ],
  "reasoning": "用户反馈图片太暗，在lighting字段添加更亮的描述，并将lighting权重从0.5提升到0.8"
}
```

**Diff 应用逻辑**：

```python
def apply_diff(original_schema: dict, diff: dict) -> dict:
    """
    应用 Diff 到原 Schema，生成新 Schema

    Args:
        original_schema: 原始 Schema
        diff: Prompt Diff

    Returns:
        new_schema: 应用修改后的新 Schema
    """
    new_schema = copy.deepcopy(original_schema)

    for op in diff["operations"]:
        action = op["action"]
        field = op["field"]

        if action == "add":
            # 添加元素到数组字段
            if field not in new_schema:
                new_schema[field] = []
            new_schema[field].extend(op["values"])

        elif action == "remove":
            # 从数组字段移除元素
            if field in new_schema:
                for val in op["values"]:
                    if val in new_schema[field]:
                        new_schema[field].remove(val)

        elif action == "adjust":
            # 调整 weights 权重
            keys = field.split(".")  # "weights.lighting" -> ["weights", "lighting"]
            current = new_schema
            for key in keys[:-1]:
                current = current[key]
            current[keys[-1]] += op["delta"]
            current[keys[-1]] = max(0.1, min(1.5, current[keys[-1]]))  # 限制范围

        elif action == "replace":
            # 完全替换字段
            keys = field.split(".")
            current = new_schema
            for key in keys[:-1]:
                current = current[key]
            current[keys[-1]] = op["value"]

    # 冲突检测
    conflicts = detect_conflicts(new_schema)
    if conflicts:
        raise ConflictError(conflicts)

    return new_schema
```

### 4.4 Adapter Layer（模型适配）

**职责**：将标准 Schema 转换为不同模型的 Prompt 格式。

**当前实现**（SeeDream）：

```python
def schema_to_seedream_prompt(schema: dict) -> str:
    """
    将 Schema 渲染为 SeeDream 的自然语言 Prompt

    基于对话文件 aa 中的案例格式
    """
    prompt_parts = []

    # 1. 画面比例和风格要求
    if "quality" in schema:
        prompt_parts.append(f"画面比例：16:9，{', '.join(schema['quality'])}")

    # 2. 风格要求
    if "style" in schema:
        prompt_parts.append(f"风格要求：{', '.join(schema['style'])}")

    # 3. 主体场景与构图
    prompt_parts.append("\n【主体场景与构图】")
    if "subject" in schema:
        prompt_parts.append(f"主体：{', '.join(schema['subject'])}")
    if "composition" in schema:
        prompt_parts.append(f"构图：{', '.join(schema['composition'])}")

    # 4. 角色/物体外观
    if "appearance" in schema:
        prompt_parts.append(f"\n【外观细节】")
        prompt_parts.append(', '.join(schema['appearance']))

    # 5. 光照与材质
    if "lighting" in schema:
        prompt_parts.append(f"\n【光照与氛围】")
        prompt_parts.append(', '.join(schema['lighting']))

    # 6. 背景
    if "background" in schema:
        prompt_parts.append(f"\n【背景】")
        prompt_parts.append(', '.join(schema['background']))

    # 7. 负面提示
    if "negative" in schema:
        prompt_parts.append(f"\n【负向提示（避免）】")
        prompt_parts.append(', '.join(schema['negative']))

    return '\n'.join(prompt_parts)
```

**未来扩展**（SD3.5）：

```python
def schema_to_sd35_prompt(schema: dict) -> str:
    """
    将 Schema 转换为 SD3.5 的关键词堆叠格式

    示例输出：
    "cat, orange fur, blue eyes, soft lighting, warm tone,
     window background, morning, anime style, semi-realistic,
     high quality, 4k, detailed"
    """
    keywords = []

    # 按优先级顺序提取关键词
    for field in ["subject", "appearance", "style", "lighting",
                  "background", "quality"]:
        if field in schema:
            keywords.extend(schema[field])

    # 添加权重强调（SD 格式）
    weighted_keywords = []
    for kw in keywords:
        if schema.get("weights", {}).get("style", 1.0) > 1.0:
            weighted_keywords.append(f"({kw}:1.2)")
        else:
            weighted_keywords.append(kw)

    # 添加负面提示
    positive_prompt = ", ".join(weighted_keywords)
    negative_prompt = ", ".join(schema.get("negative", []))

    return {
        "prompt": positive_prompt,
        "negative_prompt": negative_prompt
    }
```

### 4.5 版本管理系统

**设计思路**：每次生成/迭代都创建一个新版本，形成版本树。

**数据库设计**：

```sql
-- 会话表
CREATE TABLE sessions (
    id UUID PRIMARY KEY DEFAULT gen_random_uuid(),
    created_at TIMESTAMP DEFAULT CURRENT_TIMESTAMP,
    updated_at TIMESTAMP DEFAULT CURRENT_TIMESTAMP
);

-- 版本表
CREATE TABLE versions (
    id UUID PRIMARY KEY DEFAULT gen_random_uuid(),
    session_id UUID NOT NULL REFERENCES sessions(id) ON DELETE CASCADE,
    version_number INTEGER NOT NULL,
    parent_version_id UUID REFERENCES versions(id),

    -- 用户输入
    user_input TEXT,
    user_feedback TEXT,

    -- Prompt 数据
    schema JSONB NOT NULL,
    prompt TEXT NOT NULL,
    diff JSONB,

    -- 图片数据
    image_url TEXT NOT NULL,
    image_path TEXT NOT NULL,

    -- 元数据
    created_at TIMESTAMP DEFAULT CURRENT_TIMESTAMP,

    CONSTRAINT unique_session_version UNIQUE (session_id, version_number)
);

-- 索引
CREATE INDEX idx_session_versions ON versions(session_id, version_number);
CREATE INDEX idx_parent_version ON versions(parent_version_id);
CREATE INDEX idx_schema_gin ON versions USING gin(schema);
```

**版本树结构**：

```
Session: abc-123
│
├─ v1: "画一只猫" (初始生成)
│   │
│   ├─ v2: "太暗了" (迭代优化)
│   │   │
│   │   └─ v3: "背景简化" (继续优化)
│   │
│   └─ v4: "换个角度" (从v1分支)
│
└─ v5: 回滚到v1并修改 "改成黑猫"
```

**API 接口**：

```python
# 获取版本树
GET /api/v1/sessions/{session_id}/tree
Response:
{
  "session_id": "abc-123",
  "root_version": {
    "id": "v1",
    "version_number": 1,
    "user_input": "画一只猫",
    "image_url": "...",
    "children": [
      {
        "id": "v2",
        "version_number": 2,
        "user_feedback": "太暗了",
        "children": [...]
      },
      {
        "id": "v4",
        "version_number": 4,
        "user_feedback": "换个角度",
        "children": []
      }
    ]
  }
}

# 对比两个版本
GET /api/v1/sessions/{session_id}/compare?v1=1&v2=2
Response:
{
  "version1": {...},
  "version2": {...},
  "diff": {
    "changed_fields": ["lighting", "weights.lighting"],
    "operations": [...]
  }
}
```

---

## 五、核心 API 设计

### 5.1 生成图片

```http
POST /api/v1/generate
Content-Type: application/json

Request Body:
{
  "user_input": "画一只橘猫坐在窗边看日落",
  "session_id": "uuid"  // 可选，不提供则创建新会话
}

Response (200 OK):
{
  "session_id": "abc-123",
  "version": 1,
  "schema": {
    "subject": ["一只橘猫", "坐姿"],
    "appearance": ["橘色毛发", "蓬松", "蓝色眼睛"],
    // ... 完整 Schema
  },
  "prompt": "画面比例：16:9，高清细腻\n风格要求：半写实，动漫风格...",
  "image_url": "http://localhost:8000/images/abc-123-v1.png",
  "created_at": "2025-12-18T10:30:00Z"
}

Error Responses:
- 400: 用户输入为空
- 500: GPT-4o 调用失败
- 503: SeeDream API 不可用
```

### 5.2 提交反馈并迭代

```http
POST /api/v1/feedback
Content-Type: application/json

Request Body:
{
  "session_id": "abc-123",
  "version": 1,
  "feedback": "太暗了，而且背景太复杂"
}

Response (200 OK):
{
  "session_id": "abc-123",
  "version": 2,
  "parent_version": 1,
  "diff": {
    "operations": [
      {"action": "add", "field": "lighting", "values": ["更亮的环境光", "增加高光"]},
      {"action": "remove", "field": "background", "values": ["复杂背景"]},
      {"action": "add", "field": "background", "values": ["简洁背景"]},
      {"action": "adjust", "field": "weights.lighting", "delta": 0.3}
    ],
    "reasoning": "用户反馈图片太暗且背景复杂，因此增强光照描述并简化背景"
  },
  "schema": {
    // 应用 Diff 后的新 Schema
  },
  "prompt": "...",
  "image_url": "http://localhost:8000/images/abc-123-v2.png",
  "created_at": "2025-12-18T10:35:00Z"
}

Error Responses:
- 404: Session 或 Version 不存在
- 409: Schema 冲突（修改导致矛盾）
```

### 5.3 获取历史版本

```http
GET /api/v1/sessions/{session_id}/versions

Response (200 OK):
{
  "session_id": "abc-123",
  "versions": [
    {
      "version": 1,
      "user_input": "画一只橘猫坐在窗边看日落",
      "image_url": "...",
      "created_at": "2025-12-18T10:30:00Z"
    },
    {
      "version": 2,
      "parent_version": 1,
      "user_feedback": "太暗了，而且背景太复杂",
      "image_url": "...",
      "created_at": "2025-12-18T10:35:00Z"
    }
  ]
}
```

### 5.4 回滚到指定版本

```http
POST /api/v1/sessions/{session_id}/rollback
Content-Type: application/json

Request Body:
{
  "target_version": 1,
  "new_feedback": "在版本1的基础上，把猫改成黑色"  // 可选
}

Response (200 OK):
{
  "session_id": "abc-123",
  "version": 5,  // 创建新版本
  "parent_version": 1,
  "schema": {
    // 基于版本1的 Schema，应用新的修改
  },
  "prompt": "...",
  "image_url": "http://localhost:8000/images/abc-123-v5.png",
  "created_at": "2025-12-18T10:40:00Z"
}
```

---

## 六、前端设计

### 6.1 页面布局

```
┌────────────────────────────────────────────────────────┐
│                     PRISM                               │
│  Prompt Refinement & Image Synthesis Manager           │
├────────────────────────────────────────────────────────┤
│                                                         │
│  ┌──────────────────────┐  ┌──────────────────────┐   │
│  │    输入面板          │  │    图片展示区        │   │
│  │                      │  │                      │   │
│  │  ┌────────────────┐ │  │  ┌────────────────┐ │   │
│  │  │ 用户输入框     │ │  │  │  当前图片      │ │   │
│  │  │ "画一只猫..."  │ │  │  │  [Image]       │ │   │
│  │  └────────────────┘ │  │  └────────────────┘ │   │
│  │                      │  │                      │   │
│  │  [生成图片] 按钮     │  │  版本: v2           │   │
│  │                      │  │  [下载] [对比]      │   │
│  └──────────────────────┘  └──────────────────────┘   │
│                                                         │
│  ┌──────────────────────┐  ┌──────────────────────┐   │
│  │   反馈面板           │  │   Prompt 详情        │   │
│  │                      │  │                      │   │
│  │  ┌────────────────┐ │  │  Schema:             │   │
│  │  │ "太暗了..."    │ │  │  {                   │   │
│  │  └────────────────┘ │  │    "subject": [...]  │   │
│  │                      │  │    "lighting": [...] │   │
│  │  [提交反馈] 按钮     │  │  }                   │   │
│  └──────────────────────┘  └──────────────────────┘   │
│                                                         │
│  ┌──────────────────────────────────────────────────┐ │
│  │              版本历史时间线                       │ │
│  │                                                    │ │
│  │  v1 ──→ v2 ──→ v3                                 │ │
│  │   │             │                                  │ │
│  │   └──→ v4       └──→ v5                           │ │
│  │                                                    │ │
│  │  [点击任意版本可查看/回滚]                         │ │
│  └──────────────────────────────────────────────────┘ │
└────────────────────────────────────────────────────────┘
```

### 6.2 核心组件

1. **InputPanel.vue**
   - 用户输入框（支持多行）
   - 生成按钮（带 loading 状态）
   - 历史会话列表（侧边栏）

2. **ImageDisplay.vue**
   - 图片展示（支持放大、下载）
   - 版本信息（v1, v2, ...）
   - 对比按钮（并排展示两个版本）

3. **FeedbackPanel.vue**
   - 反馈输入框
   - 常用反馈快捷按钮（"太暗"、"太亮"、"背景简化"等）
   - 提交按钮（带 loading 状态）

4. **PromptViewer.vue**
   - Schema JSON 展示（折叠树形结构）
   - 自然语言 Prompt 展示
   - Diff 高亮显示（如果是迭代版本）

5. **VersionHistory.vue**
   - 时间线展示
   - 版本缩略图
   - 点击查看详情
   - 回滚按钮

---

## 七、开发路线图

### Sprint 1: 项目基础搭建（Week 1）

**目标**：搭建开发环境，完成框架初始化

**后端任务**：
- [ ] 创建 FastAPI 项目结构
- [ ] 配置 Docker Compose（PostgreSQL + Redis）
- [ ] 定义数据库模型（Session + Version）
- [ ] 配置 SQLAlchemy ORM
- [ ] 编写配置文件（.env, config.py）
- [ ] 实现健康检查接口 `/health`

**前端任务**：
- [ ] 创建 Vue 3 + Vite 项目
- [ ] 配置 TypeScript + Pinia
- [ ] 安装 Element Plus
- [ ] 创建路由和主布局
- [ ] 设计 UI 草图（Figma 或手绘）

**联调**：
- [ ] 定义 API 接口规范文档
- [ ] 前端使用 Mock 数据测试

**交付物**：
- 可运行的空项目框架
- API 文档初稿

---

### Sprint 2: 核心生成功能（Week 2）

**目标**：实现首次生成流程（用户输入 → Prompt → 图片）

**后端任务**：
- [ ] 实现 Prompt Schema 数据结构
- [ ] 编写生成阶段 System Prompt 模板（基于对话 aa）
- [ ] 实现 Prompt Engine（调用 GPT-4o）
- [ ] 集成 SeeDream API
- [ ] 实现 Adapter Layer（Schema → SeeDream Prompt）
- [ ] 实现图片存储服务（本地文件系统）
- [ ] 完成 `/api/v1/generate` 接口
- [ ] 添加日志和错误处理

**前端任务**：
- [ ] 实现 InputPanel 组件
- [ ] 实现 ImageDisplay 组件
- [ ] 实现 PromptViewer 组件
- [ ] 对接生成 API
- [ ] 添加 Loading 状态和错误提示

**联调**：
- [ ] 端到端测试生成流程
- [ ] 优化响应速度（异步处理）

**交付物**：
- 可以生成图片的完整流程
- 演示视频1：用户输入 → 生成图片

---

### Sprint 3: 多轮迭代功能（Week 3）

**目标**：实现反馈迭代流程（反馈 → Prompt Diff → 新图片）

**后端任务**：
- [ ] 编写反馈阶段 System Prompt 模板
- [ ] 实现 Feedback Engine（反馈理解 + Diff 生成）
- [ ] 实现 Diff 应用逻辑
- [ ] 实现冲突检测
- [ ] 完成 `/api/v1/feedback` 接口
- [ ] 实现版本管理（存储版本树）

**前端任务**：
- [ ] 实现 FeedbackPanel 组件
- [ ] 实现 DiffViewer 组件（高亮显示修改）
- [ ] 实现 VersionHistory 组件
- [ ] 实现版本对比功能
- [ ] 对接反馈 API

**联调**：
- [ ] 测试多轮迭代流程
- [ ] 验证 Diff 准确性
- [ ] 测试版本树的正确性

**交付物**：
- 完整的迭代优化功能
- 演示视频2：多轮反馈优化

---

### Sprint 4: 优化与完善（Week 4）

**目标**：性能优化、UI 完善、文档编写

**后端任务**：
- [ ] 性能优化（异步处理、缓存）
- [ ] 添加数据库索引
- [ ] 完善错误处理和日志
- [ ] 编写 API 文档（OpenAPI/Swagger）
- [ ] 单元测试（核心模块）

**前端任务**：
- [ ] UI/UX 优化（动画、交互）
- [ ] 响应式设计（适配不同屏幕）
- [ ] 快捷键支持（Ctrl+Enter 生成）
- [ ] 暗色主题（可选）

**文档与演示**：
- [ ] 编写大作业报告（架构设计、技术亮点）
- [ ] 准备演示 PPT
- [ ] 录制完整演示视频
- [ ] 编写 README.md

**交付物**：
- 完整的可演示项目
- 大作业文档
- 演示视频

---

## 八、技术亮点与创新点

### 8.1 LLM 应用深度

**不是简单的 API 调用，而是完整的 Prompt Engineering 系统**：

1. **System Prompt 精心设计**
   - 基于真实优秀案例（对话 aa）
   - Few-shot learning 提升效果
   - 强约束输出格式（JSON Schema）

2. **多阶段 LLM 调用**
   - 生成阶段：创意 → 详细 Prompt
   - 反馈阶段：反馈 → Prompt Diff
   - 每个阶段都有专门的 System Prompt

3. **输出质量保证**
   - Schema 验证（Pydantic）
   - 冲突检测
   - 错误重试机制

### 8.2 创新的 Prompt Diff 机制

**类似 Git Diff，对 Prompt 进行精确版本控制**：

1. **结构化表示**
   - 将自然语言 Prompt 转换为可编程的 JSON
   - 支持字段级别的修改

2. **最小修改原则**
   - 只修改与反馈相关的部分
   - 保持其他内容稳定

3. **可追溯、可回滚**
   - 每次修改都记录 Diff
   - 可以回到任意历史版本
   - 可以分支和合并

### 8.3 可扩展架构

**Adapter Pattern 支持多模型**：

```
Schema（标准格式）
    ↓
Adapter Layer
    ├─ SeeDream Adapter → 中文自然语言
    ├─ SD3.5 Adapter → 关键词堆叠
    └─ Midjourney Adapter → MJ 语法
```

**未来可轻松接入**：
- Stable Diffusion 3.5
- Midjourney
- DALL-E
- Flux

### 8.4 现代 Web 开发规范

1. **前后端分离**：RESTful API
2. **类型安全**：TypeScript + Pydantic
3. **容器化**：Docker Compose
4. **API 文档**：自动生成（FastAPI）
5. **代码规范**：ESLint + Black
6. **版本控制**：Git + 清晰的 commit message

---

## 九、风险与应对

### 9.1 技术风险

| 风险 | 影响 | 应对措施 |
|------|------|---------|
| GPT-4o API 不稳定 | 生成失败 | 实现重试机制 + 降级到 GPT-4 |
| SeeDream API 限流 | 无法生成图片 | 添加队列 + 速率限制 |
| Prompt Diff 不准确 | 修改偏离预期 | 多次测试 + 优化 System Prompt |
| 数据库性能问题 | 查询慢 | 添加索引 + 使用 Redis 缓存 |

### 9.2 成本风险

| 项目 | 预估成本 | 控制措施 |
|------|---------|---------|
| GPT-4o API | $0.01/次 | 限制调用次数，开发阶段使用小数据 |
| SeeDream API | 按量计费 | 开发阶段使用低分辨率 |
| 图片存储 | 本地免费 | MVP 阶段使用本地存储 |

### 9.3 时间风险

**最坏情况**：某个 Sprint 延期

**应对措施**：
- 功能分优先级（P0/P1/P2）
- P0（必须）：基础生成 + 单轮迭代
- P1（重要）：多轮迭代 + 版本管理
- P2（加分）：UI 优化 + 额外功能

---

## 十、成功标准

### 10.1 功能完整性

- ✅ 用户可以输入简单描述，生成详细 Prompt 和图片
- ✅ 用户可以对图片提出反馈，系统精确修改并重新生成
- ✅ 用户可以查看历史版本，对比不同版本
- ✅ 所有 Prompt 和 Schema 可追溯、可回滚

### 10.2 技术深度

- ✅ 展示对 LLM 的深度应用（System Prompt 设计、多阶段调用）
- ✅ 展示创新的 Prompt Diff 机制
- ✅ 展示结构化数据设计能力（Schema 设计）
- ✅ 展示现代 Web 开发能力（前后端分离、类型安全、容器化）

### 10.3 演示效果

- ✅ 3-5 分钟完整演示视频
- ✅ 清晰的架构图和流程图
- ✅ 实际生成的图片对比（展示迭代优化效果）
- ✅ 代码注释充分，易于理解

---

## 十一、总结

PRISM 项目通过以下创新设计，解决了 AI 绘画领域的核心痛点：

1. **结构化 Prompt**：将自然语言转换为可编程的数据结构
2. **智能优化中间层**：GPT-4o + 精心设计的 System Prompt
3. **Prompt Diff 机制**：精确控制修改范围，避免破坏性变更
4. **完整版本管理**：支持历史追溯和任意回滚

这是一个技术深度与实用性兼具的项目，既能作为大作业展示 LLM 应用能力，也能为未来的产品化打下基础。

---

**项目仓库**：`hhttps://github.com/BugUniversity-2024/2025-LLMCP-PRISM`
**联系方式**：AptS:1547 & AptS:1548

**文档版本**：v1.0
**最后更新**：2025-12-18
